## Sequence Processing

### Pipeline characteristics

__Section objectives__
* make non-quantitative statements
* capturing differences in quality across samples 
* Statements/ Figures showing how datasets behave


```{r echo = FALSE}
mrexp_files <- list(
      dada2 = "data/mrexp_dada2.RDS",
      mothur = "data/mrexp_mothur.RDS",
      qiime = "data/mrexp_qiime_refclus_nochimera.RDS"
)
mrexp <- mrexp_files %>% map(readRDS)
```

```{r echo = FALSE}
## number of OTUs
dadaOTU <- NROW(mrexp$dada2)
mothurOTU <- NROW(mrexp$mothur)
qiimeOTU <- NROW(mrexp$qiime)
```



* Characterization of different pipelines
      - total number of features   
            - DADA2 `r dadaOTU`  
            - mothur `r mothurOTU`   
            - qiime `r qiimeOTU`  

      - different taxonomic assignments
      - number of assigned vs. non-assigned

### Alpha Diversity (richness comparison) 
Comparison of feature richness between bioinformatic pipelines (\@ref(fig:alpha_div)). 

```{r alpha_div, fig.cap = "Alpha diversity metrics calculated for the different sequence processing pipelines.", echo = FALSE, message=FALSE}
## calc_alpha function in lib 
mrexp %>% map_df(calc_alpha,.id = "pipe") %>% 
      filter(!is.na(sampleID), sampleID != "NTC") %>% 
      ggplot() + geom_point(aes(x = sampleID, y = value, color = factor(dilution))) +
      theme_bw() + theme(legend.position = "bottom") +
      facet_grid(div_index~pipe, scales = "free") +
      labs(color = "Titration Factor", y = "Diversity Metric", x = "Biological Replicate") +
      theme(axis.text.x = element_text(angle = 90))
```

#### Rarefaction Curves
- Use to show coverage 
- Unmixed only (include pooled replicates)
```{r}
curve_df <- mrexp %>% map_df(get_curve_df, .id = "pipe")
```


```{r}
ggplot(curve_df) + 
    geom_path(aes(x = sample, y = OTUs, color = factor(dilution), group = samID)) +
    facet_grid(pipe~sampleID, scales = "free") + 
    theme_bw() + theme(legend.position = "bottom")
```


### Beta Diversity - Overall sample similarity

### Species abundance distributions
- Characterize differences between clustering methods 

```{r}
mrexp$qiime@assayData$counts %>% rowSums() %>% sads::rad() %>% plot()
```

```{r}
mrexp$mothur@assayData$counts %>% rowSums() %>% sads::rad() %>% plot()
```

```{r}
mrexp$dada2@assayData$counts %>% rowSums() %>% sads::rad() %>% plot()
```


### MA plot to demonstrate observed fold changes 
```{r}
sample_ids <- pData(mrexp$dada2)$sampleID %>% unique()
sample_ids <- sample_ids[sample_ids != "NTC"]

ma_df <- mrexp %>% map_df(get_ma_df_by_sample, sample_ids, .id = "pipe")
```

```{r ma_plot, fig.cap = "MA plot for different bioinformatic pipelines. Points at top and bottom of plots are OTUs only present in pre-treatment and post-treatment samples respectively."}
# __TODO__ Filter low quality samples 
ggplot(ma_df) + geom_point(aes(x = A, y = logFC, group = otu, color = sampleID), alpha = 0.5) + 
      geom_hline(aes(yintercept = -1), linetype = 2) + 
      geom_hline(aes(yintercept = 1), linetype = 2) + 
      theme_bw() +
      scale_x_log10() +
      facet_wrap(~pipe)
```


