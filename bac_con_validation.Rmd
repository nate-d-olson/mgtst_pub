---
title: "Bacterial DNA Concentration qPCR"
author: "Nate Olson"
date: '`r Sys.Date()`'
output:
  bookdown::pdf_document2: 
    toc: FALSE
--- 

```{r bac_setup, warning=FALSE, message=FALSE, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
library(ProjectTemplate)
load.project()
library(modelr)
library(broom)
```

```{r warning=FALSE, message=FALSE, echo = FALSE}
mod <- qpcrBacStd %>% 
      filter(std == "shan", conc >= 0.2) %>% mutate(log_conc = log10(conc)) %>% 
      {lm(log_conc~Ct, data = .)}

bac_abu <- qpcrBacAbu %>% filter(!is.na(Ct), std == "shan") %>% 
      add_predictions(mod) %>% 
      mutate(quant = 10^pred)

#### Standard Curve Summary Metrics
fit <- qpcrBacStd %>% 
      filter(std == "shan", conc >= 0.2) %>%
      mutate(log_conc = log10(conc)) %>% 
      {lm(Ct~log_conc, data = .)} 

mod_summary <- summary(fit)
std_r2 <- mod_summary$adj.r.squared
std_slope <- mod_summary$coefficients[2,1]
af <- 10^(-1/std_slope)
efficiency <- (af - 1) * 100

### DNA Concentration Plot data
sample_name_df <- data_frame(bio_rep = as.character(1:5),
                             biosample_id = paste0("E01JH00",c("04","11","16","17","38")))

bac_con_plot <- bac_abu %>% 
      filter(sample_name != "NTC") %>% 
      ungroup() %>% 
      mutate(sample_name = gsub(" ","_", sample_name)) %>% 
      separate(sample_name, c("bio_rep","titration"), sep = "_") %>% 
      left_join(sample_name_df) %>% 
      mutate(titration = case_when(titration %in% paste0("M",c(0:20)) ~ str_replace(titration, "M",""),
                                   titration == "Pre" ~ "20", 
                                   titration == "Post" ~ "0"),
             titration = as.numeric(titration)) %>% 
      filter(titration != 0) %>%
      mutate(t_group = if_else(titration <= 5, "low","high")) 

######### Model Fit data
bac_con_fit <- bac_con_plot %>% 
      group_by(biosample_id, t_group) %>% nest() %>% 
      mutate(fit = map(data, ~lm(quant~titration, data = .)),
             fit_tdy = map(fit, tidy),
             fit_glance = map(fit, glance))

######### E01JH0017 
## Fit model to titration series with and without titration 5
bac_con17_full <- bac_con_plot %>% filter(biosample_id == "E01JH0017") 
fit_17_full <- lm(quant~titration, data = bac_con17_full)
slope_17_full <- coefficients(fit_17_full)[2]
r2_17_full <- rsquare(fit_17_full, bac_con17_full)


bac_con17_no5 <- bac_con_plot %>% 
      filter(biosample_id == "E01JH0017", titration != 5) 
fit_17_no5 <- lm(quant~titration, data = bac_con17_no5)
slope_17_no5 <- coefficients(fit_17_no5)[2]
r2_17_no5 <- rsquare(fit_17_no5, bac_con17_no5)
# %>% 
#       group_by(biosample_id) %>% nest() %>% 
#       mutate(fit = map(data, ~lm(quant~titration, data = .)),
#              fit_tdy = map(fit, tidy),
#              fit_glance = map(fit, glance))
```


```{r bacConFit, warning=FALSE, message=FALSE, echo = FALSE}
bac_con_r2 <- bac_con_fit %>% filter(t_group == "low") %>% 
      select(biosample_id, fit_glance) %>% unnest() %>% 
      select(biosample_id, adj.r.squared)

bac_con_fit %>% select(biosample_id, t_group, fit_tdy) %>% 
      filter(t_group == "low") %>% 
      unnest() %>% filter(term == "titration") %>% 
      add_column(adj.p.value =  p.adjust(.$p.value, method = "BH")) %>% 
      select(biosample_id, estimate, std.error, adj.p.value) %>% 
      arrange(biosample_id) %>% 
      left_join(bac_con_r2) %>% 
      rename(`Std. Error` = std.error, `Adj. p-value` = adj.p.value, 
             `Individual` = biosample_id,
             Slope = estimate,
             `$R^2$` = adj.r.squared) %>% 
      knitr::kable(digits = 4, caption = "Slope estimates for linear model of prokaryotic DNA concentration and titration factor. Separate linear models were fit for each titrations 1-4 for each  individual. Multiple test correction was performed using the Benjamini-Hochberg method. p-value indicates signficant difference from the expected slopes of 0.",  booktabs = TRUE)
```


```{r bacPlot, fig.cap = "Prokaryotic DNA concentration (ng/ul) across titrations 1-4 measured using a 16S rRNA qPCR assay", warning=FALSE, message=FALSE, echo = FALSE}
bac_con_plot %>% 
      filter(t_group != "high") %>% 
      ggplot() +
      geom_point(aes(y = quant, x = titration)) +
      geom_smooth(aes(x = titration, y = quant), method = "lm") + 
      facet_grid(~biosample_id, scales = "free") +
      theme_bw() + labs(x = "Titration Factor", y = "DNA concentration (ng/ul)") +
      theme(legend.position = "none")
```

The proportion of prokaryotic DNA changes across titrations, indicating the proportion of bacterial DNA from the unmixed pre- and post-exposure samples in a titration is not consistent with the mixture design.
A qPCR assay targeting the 16S rRNA gene was used to quantify the concentration of prokaryotic DNA in the titrations. 
An in-house standard curve with concentrations of 20 ng/ul, 2ng/ul, and 0.2 ng/ul was used. 
Standard curve efficiency `r round(efficiency,2)`, and $R^2$ `r round(std_r2,2)`. 
If the proportion of prokaryotic DNA is the same between pre- and post-exposure samples the slope of the concentration estimates across the two-sample titration would be 0. 
For individuals where the proportion of prokaryotic DNA is higher in the pre-exposure samples the slope will be negative and positive when the proporition is higher for post-exposure samples. 
For titrations 1-5 the slope estimates are significantly different from 1 for individuals E01JH00016, E01JH0017, and E01JH00038 (Table \@ref(tab:bacConFit), Fig. \@ref(fig:bacPlot)). 
These results indicate that the proportion of prokaryotic DNA is higher in the post-exposure sample than the pre-exposure sample for E01JH0016 and E01JH0038, lower in the post-exposure sample for E01JH0017, with no detectable difference for E01JH0004 and E01JH0011. 
