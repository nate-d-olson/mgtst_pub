---
title: "logFC Assessment"
author: "Nate Olson"
date: '`r Sys.Date()`'
output:
  bookdown::pdf_document2: 
    toc: FALSE
---



```{r logFC_setup, include=FALSE}
library(tidyverse)
library(stringr)
library(ggpubr)
```

```{r logFCtidy, include = FALSE}
### Loading Data ---------------------------------------------------------------
pa_summary_df <- readRDS("~/Desktop/pa_summary_anno_df.RDS") %>% 
      select(pipe, biosample_id, feature_id, 
             T00, T20, pa_mixed) %>% 
      filter(biosample_id %in% paste0("E01JH00", c("04","11","16")))

logFC_df <- readRDS("~/Desktop/logFC_edgeR_df.rds") %>%
      filter(biosample_id %in% paste0("E01JH00", c("04","11","16")))

logFC_df <- logFC_df %>% 
      ## Fixing taxonomy for consistency
      mutate(Rank2 = str_replace(Rank2, "p__",""),
             Rank3 = str_replace(Rank3, "c__",""),
             Rank4 = str_replace(Rank4, "o__",""),
             Rank5 = str_replace(Rank5, "f__",""),
             Rank6 = str_replace(Rank6, "g__","")) %>% 
      dplyr::rename(feature_id = OTUname) %>%
      left_join(pa_summary_df)

### Extracting pre-specific and dominant features -----------------------------
logFC_prepost <- logFC_df %>% 
      filter(T1 == 0, T2 == 20)

logFC_pre <- logFC_prepost %>% 
      filter(logFC > 5, T20 == 4) %>% 
      group_by(biosample_id) %>% 
      dplyr::rename(prepost_logFC = logFC, prepost_logCPM = logCPM) %>% 
      ungroup() %>% 
      select(-T1, -T2, -PValue, -FDR) %>% 
      left_join(logFC_df)

### Calculate Expected logFC ------------------------------------------------- 
#Function for coverting numeric factors to their numeric values
as_numeric_fctr <- function(x) as.numeric(as.character(x))

logFC_pre <- logFC_pre %>% 
      mutate(T1_preprop = 1 - 2^-as_numeric_fctr(T1), 
             T2_preprop = 1 - 2^-as_numeric_fctr(T2),
            exp_logFC = log2(T2_preprop/T1_preprop)) 

### Calculating logFC Error Rate ----------------------------------------------
logFC_pre_error_rate <- logFC_pre %>% 
      filter(T1 %in% 1:5, T2 %in% 1:5) %>% 
      mutate(error_rate = abs(exp_logFC - logFC)/exp_logFC)

logFC_pre_error <- logFC_pre_error_rate %>% 
      group_by(pipe, biosample_id, feature_id, 
               prepost_logFC, prepost_logCPM,
               Rank2, Rank3, Rank4, Rank5, Rank6) %>% 
      summarise(med_logCPM = median(logCPM),
                median_error = median(error_rate, na.rm = TRUE),
                iqr_error = IQR(error_rate, na.rm = TRUE),
                rcov_error = iqr_error/median_error)


### logFC Error Rate Plot Code ------------------------------------------------
### Estimated v. Expected 
logFCestVexp <- logFC_pre %>% 
      filter(T1 != 0, T2 != 20) %>% 
      ggplot() + 
      geom_point(aes(x = logFC, y = exp_logFC)) +
      geom_smooth(aes(x = logFC, y = exp_logFC), method = "lm") +
      geom_abline(aes(intercept = 0, slope = 1), color = "darkorange") + 
      facet_grid(pipe~biosample_id) + theme_bw()  +
      labs(x = "Estimated", y = "Expected") 

### Median logFC Error Rate  
med_logFC <- ggplot(logFC_pre_error) + 
      geom_boxplot(aes(x = pipe, y = median_error)) + 
      facet_wrap(~biosample_id) +
      theme_bw() +
      labs(x = "Individual", y = "Median") 

### RCOV logFC Error Rate  
rcov_logFC <- logFC_pre_error %>% ggplot() + 
      geom_boxplot(aes(x = pipe, y = rcov_error)) + 
      facet_wrap(~biosample_id) +
      theme_bw() +
      labs(x = "Individual", y = "RCOV")
```

Across all pipelines and individuals the estimated and expected logFC estimates were positively correlated (Fig. \@ref(fig:logFCerror)A). 
However, the slope of the linear relationship between the expected and estimated log fold-change estimates were less than 1 for all pipelines and individuals, with low adjusted $R^2$ values, with median and minimum-maximum of 0.035 (0.00048-0.093)) and slope estimates (0.075 (0.018-0.12)). 
Outlier features were the primary driver of the lower than expected slope estimates. __Need to verify__ 
The bias and variance of the log fold-change estimates were compared between pipelines. 
Similar to the relative abundance assessment we used a mixed-effects models to take into account differences in individuals when comparing the log fold-change error rates between pipeline. 
There was no statistical difference in the log fold-change error feature-level median error rate \@ref(fig:logFCerror)B) or error rate RCOV \@ref(fig:logFCerror)C). 
An additional mixed-effects model was used to determine feature characteristics that are correlated with logFC error rate. 
Increased estimated logFC and logCPM were significantly related to lower error rates. 

```{r preCountTbl, echo = FALSE}
logFC_pre %>% filter(T1 == 0, T2 == 20) %>%
      mutate(Type = if_else(T00 == 0, "specific", "dominant")) %>% 
      group_by(pipe, biosample_id, Type) %>% 
      summarise(count = n()) %>% 
      spread(pipe, count,fill = 0) %>% 
      dplyr::rename(Individual = biosample_id) %>% 
      knitr::kable(caption = "Number of pre-specific and pre-dominant features by individual and pipeline", booktabs = TRUE)
```



```{r logFCerror, fig.cap = "Relationship between the observed and expected logFC for pre-specific and pre-domiant features by pipeline and individual for all titration pair comparisons. Orange line indicates expected 1-to-1 relationship between the estimated and expected logFC. Blue line is a linear model was fit to the data and grey area is the models uncertainty estimate. Distribution of feature-level (B) median error rate and (C) robust coefficient of variation (RCOV) by individual and pipeline", echo = FALSE, fig.height = 8}
ggarrange(logFCestVexp, 
          med_logFC + rremove("x.text"), 
          rcov_logFC, 
          labels = c("A", "B", "C"),
          # align = "v", 
          ncol = 1, nrow = 3, 
          heights = c(0.5,0.2,0.3))
```
