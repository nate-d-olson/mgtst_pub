---
title: "logFC Assessment"
author: "Nate Olson"
date: '`r Sys.Date()`'
output:
  bookdown::pdf_document2: 
    toc: FALSE
---



```{r logFCsetup, include=FALSE}
library(nlme)
library(ape)
library(multcomp)
library(tidyverse)
library(stringr)
library(ggridges)
library(ggpubr)
```

```{r logFCmunge, include = FALSE}
### Loading Data ---------------------------------------------------------------
### RDS file generated in 2017-10-19_logFC-error-metrics.RDS 
logFC_pre <- readRDS("~/Desktop/logFC_pre.RDS")

logFC_feature_summary <- readRDS("~/Desktop/logFC_feature_summary.RDS") %>% 
      mutate(slope_error = 1 - slope)

### logFC Est v. Exp Regression ------------------------------------------------
logFCestVexp <- logFC_pre %>% 
      filter(T1 != 0, T2 != 20) %>% 
      ggplot() + 
      # geom_point(aes(x = exp_logFC, y = logFC), alpha = 0.15) +
      geom_smooth(aes(x = exp_logFC, y = logFC, color = pipe), method = "lm") +
      geom_abline(aes(intercept = 0, slope = 1), color = "grey20", linetype = 2) + 
      facet_wrap(~biosample_id, ncol = 1, scale = "free_y") + theme_bw()  +
      labs(x = "Expected", y = "Estimate", color = "Pipeline") 


### Error Distribution ---------------------------------------------------------
logFC_error <- logFC_pre %>% 
      filter(T1 != 0, T2 != 20) %>% 
      dplyr::select(biosample_id, pipe, feature_id, exp_logFC, logFC) %>% 
      mutate(error = abs(logFC - exp_logFC))
      
logFC_error_dist <- logFC_error %>% 
      ggplot() + 
      geom_density_ridges(aes(x = error, y = pipe, color = pipe), alpha = 0.5) + 
      facet_wrap(~biosample_id, ncol = 1) + theme_bw() + 
      labs(x = "Error", y = "Pipeline", color = "Pipeline")

### logFC Bias: 1-slope  -------------------------------------------------------
slope_logFC <- logFC_feature_summary %>% 
      ggplot() + 
      geom_boxplot(aes(x = pipe, y = slope_error, color = pipe), 
                   outlier.shape = NA) + 
      geom_hline(aes(yintercept = 0), color = "grey20", linetype = 2) + 
      facet_wrap(~biosample_id, ncol = 1) +
      theme_bw() +
      labs(x = "Pipeline", y = "1 - Slope", color = "Pipeline") 

ymin <- ggplot_build(slope_logFC)$data[[1]]$ymin %>% min()
ymax <- ggplot_build(slope_logFC)$data[[1]]$ymax %>% max()
slope_logFC <- slope_logFC + coord_cartesian(ylim = c(ymin, ymax))

### logFC Variance: R2 ---------------------------------------------------------
r2_logFC <- logFC_feature_summary %>% 
      # filter(slope < 4) %>% 
      ggplot() + 
      geom_boxplot(aes(x = pipe, y = adj.r.squared, color = pipe), 
                   outlier.shape = NA) + 
      geom_hline(aes(yintercept = 1), color = "grey20", linetype = 2) + 
      facet_wrap(~biosample_id, ncol = 1) +
      theme_bw() +
      labs(x = "Pipeline", y = "Adjusted $R^2$", color = "Pipeline") 


ymin <- ggplot_build(r2_logFC)$data[[1]]$ymin %>% min()
ymax <- ggplot_build(r2_logFC)$data[[1]]$ymax %>% max()
r2_logFC <- r2_logFC + coord_cartesian(ylim = c(ymin, ymax))
```


```{r logFCstats, echo = FALSE, message = FALSE, warning = FALSE}
fit_dat <- logFC_feature_summary %>% 
      # filter(slope < 4) %>%
      filter(pipe != "unclustered") %>% 
      mutate(pipe = factor(pipe))

## Bias - Error rate -----------------------------------------------------------
# Fitting mixed effects model with individual as the fixed effect
slope_fit <- nlme::lme(slope_error ~ pipe, random =  ~ 1 | biosample_id, 
                 data = fit_dat)  
## Residual check
# qqnorm(slope_fit$residuals) + abline(a = 0, b =  1, col = 'red')

# Pipe 1-slope estimates
dada_slope <- slope_fit$coefficients$fixed['(Intercept)']
mothur_slope <- dada_slope + slope_fit$coefficients$fixed['pipemothur']
qiime_slope <- dada_slope + slope_fit$coefficients$fixed['pipeqiime']

slope_anova <- anova(slope_fit)
slope_f <- slope_anova$`F-value`
slope_p <- slope_anova$`p-value`

# Checking whether indiviudal or pipeline contributes more to the overal vaiance
slope_var <- ape::varcomp(slope_fit)

## Variance - RCOV -------------------------------------------------------------
# Fitting mixed effects model with individual as the fixed effect
r2_fit <- nlme::lme(adj.r.squared ~ pipe, random =  ~ 1 | biosample_id, 
                 data = fit_dat)

# qqnorm(r2_fit$residuals) + abline(a = 0, b =  1, col = 'red')

# Pipe R2 estimates
dada_r2 <- r2_fit$coefficients$fixed['(Intercept)']
mothur_r2 <- dada_r2 + r2_fit$coefficients$fixed['pipemothur']
qiime_r2 <- dada_r2 + r2_fit$coefficients$fixed['pipeqiime']

r2_anova <- anova(r2_fit)
r2_f <- r2_anova$`F-value`
r2_p <- r2_anova$`p-value`

# Checking whether indiviudal or pipeline contributes more to the overal vaiance
r2_var <- ape::varcomp(r2_fit)
```

```{r preCountTbl, echo = FALSE}
logFC_pre %>% filter(T1 == 0, T2 == 20) %>%
      mutate(Type = if_else(T00 == 0, "specific", "dominant")) %>% 
      group_by(pipe, biosample_id, Type) %>% 
      summarise(count = n()) %>% 
      spread(pipe, count,fill = 0) %>% 
      dplyr::rename(Individual = biosample_id) %>% 
      knitr::kable(caption = "Number of pre-specific and pre-dominant features by individual and pipeline", booktabs = TRUE)
```

```{r logFCestVexp, echo = FALSE, warning = FALSE, message = FALSE}
# logFC_pre %>% 
#       filter(T1 != 0, T2 != 20) %>% 
#       ggplot() + 
#       geom_point(aes(x = exp_logFC, y = logFC), alpha = 0.15) +
#       geom_abline(aes(intercept = 0, slope = 1), color = "darkorange") + 
#       facet_grid(pipe~biosample_id, scales = "free_y") + theme_bw()  +
#       labs(x = "Expected", y = "Estimate") 
```


```{r logFCerror, fig.cap = "(A) Linear model or the relationship between the logFC estimates and expeced values for pre-specific and pre-domiant features by pipeline and individual for all titration pair comparisons, color are used to indicate different pipelines. Dashed grey line indicates expected 1-to-1 relationship between the estimated and expected log fold-change. (B) Log fold-change error (|exp-est|) distribtion by pipeline and individual. Distribution of feature-level log-fold change error by individual and pipeline as the (C) 1 - slope and (D) $R^2$ for a linear model fit to the estimated and expected log fold-change values ", echo = FALSE, message = FALSE, fig.height = 8}
ggarrange(logFCestVexp, 
          logFC_error_dist + rremove("y.text"), 
          slope_logFC + rremove("x.text"), 
          r2_logFC + rremove("x.text"), 
          labels = "AUTO",
          # align = "v", 
          ncol = 4, nrow = 1, 
          common.legend = TRUE,
          legend = "bottom")
```

The 1-slope and $R^2$ values for linear models of the estimated and expected log fold-change for individual features, all titration comparison, were used to characterize the log fold-change bias and variance across pipelines. 
A error metric of $1 - slope$ was used, where 0 is the desired value (i.e. log fold-change estimate = log fold-change expected), negative and positive values indicate the log-fold change was consistently under and over estimated, respectively. 
The linear model $R^2$ value was used to characterize the feature-level log fold-change variance as it indicates how consistent the relationship between the log fold-change estimates and expected values are across titration comparisons. 
Similar to the relative abundance assessment we used a mixed-effects models to take into account differences in individuals when comparing the log fold-change error rates between pipeline. 
The log fold-change bias metric was not significantly different between pipelines (F = `r round(slope_f,2)`, p = `r round(slope_p,2)`, DADA2 `r round(dada_slope,2)`, Mothur `r round(mothur_slope,2)`, QIIME `r round(qiime_slope,2)`, \@ref(fig:logFCerror)B). 
The log fold-change variance metric was not significantly different between pipelines (F = `r round(r2_f,2)`, p = `r round(r2_p,2)`, DADA2 `r round(dada_r2,2)`, Mothur `r round(mothur_r2,2)`, QIIME `r round(qiime_r2,2)`, Fig. \@ref(fig:logFCerror)C).
