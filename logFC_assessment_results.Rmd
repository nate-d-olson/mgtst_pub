---
title: "logFC Assessment"
author: "Nate Olson"
date: '`r Sys.Date()`'
output:
  bookdown::pdf_document2: 
    toc: FALSE
---



```{r logFCsetup, include=FALSE}
library(nlme)
library(ape)
library(multcomp)
library(tidyverse)
library(stringr)
library(ggpubr)
```

```{r logFCmunge, include = FALSE}
### Loading Data ---------------------------------------------------------------
### RDS file generated in 2017-10-19_logFC-error-metrics.RDS 
logFC_pre <- readRDS("~/Desktop/logFC_pre.RDS")

logFC_feature_summary <- readRDS("~/Desktop/logFC_feature_summary.RDS")


### logFC Error Rate Plot Code ------------------------------------------------
### Estimated v. Expected 
logFCestVexp <- logFC_pre %>% 
      filter(T1 != 0, T2 != 20) %>% 
      ggplot() + 
      geom_point(aes(x = exp_logFC, y = logFC)) +
      geom_smooth(aes(x = exp_logFC, y = logFC), method = "lm") +
      geom_abline(aes(intercept = 0, slope = 1), color = "darkorange") + 
      facet_grid(pipe~biosample_id, scales = "free_y") + theme_bw()  +
      labs(x = "Expected", y = "Estimates") 

### Median logFC Error Rate  
# Note filtering slope < 4 is a bit arbitrary
slope_logFC <- filter(logFC_feature_summary, slope < 4) %>% ggplot() + 
      geom_boxplot(aes(x = pipe, y = slope)) + 
      facet_wrap(~biosample_id) +
      theme_bw() +
      labs(x = "Individual", y = "Slope") 

### RCOV logFC Error Rate  
r2_logFC <- filter(logFC_feature_summary, slope < 4) %>% ggplot() + 
      geom_boxplot(aes(x = pipe, y = adj.r.squared)) + 
      facet_wrap(~biosample_id) +
      theme_bw() +
      labs(x = "Individual", y = "Adjusted R2")
```


```{r logFCstats, echo = FALSE, message = FALSE, warning = FALSE}
fit_dat <- filter(logFC_feature_summary, slope < 4) %>% 
      filter(pipe != "unclustered") %>% 
      mutate(pipe = factor(pipe))

## Bias - Error rate -----------------------------------------------------------
# Fitting mixed effects model with individual as the fixed effect
slope_fit <- nlme::lme(slope ~ pipe, random =  ~ 1 | biosample_id, 
                 data = fit_dat)  

# Post-hoc test to check for pipeline differences
slope_post_hoc <- glht(slope_fit, linfct=mcp(pipe="Tukey")) 

# Checking whether indiviudal or pipeline contributes more to the overal vaiance
slope_var <- ape::varcomp(slope_fit)

## Variance - RCOV -------------------------------------------------------------
# Fitting mixed effects model with individual as the fixed effect
r2_fit <- nlme::lme(adj.r.squared ~ pipe, random =  ~ 1 | biosample_id, 
                 data = fit_dat)

# Post-hoc test to check for pipeline differences
r2_post_hoc <- glht(r2_fit, linfct=mcp(pipe="Tukey")) 

# Checking whether indiviudal or pipeline contributes more to the overal vaiance
r2_var <- ape::varcomp(r2_fit)
```
__TODO__ Revise text  

* excluding features with slope > 4 from error plots.
 
Across all pipelines and individuals the estimated and expected logFC estimates were positively correlated (Fig. \@ref(fig:logFCerror)A). 
However, the slope of the linear relationship between the expected and estimated log fold-change estimates were less than 1 for all pipelines and individuals, with low adjusted $R^2$ values, with median and minimum-maximum of 0.035 (0.00048-0.093)) and slope estimates (0.075 (0.018-0.12)). 
Outlier features were the primary driver of the lower than expected slope estimates. __Need to verify__ 
The bias and variance of the log fold-change estimates were compared between pipelines. 
Similar to the relative abundance assessment we used a mixed-effects models to take into account differences in individuals when comparing the log fold-change error rates between pipeline. 
There was no statistical difference in the log fold-change error feature-level median error rate \@ref(fig:logFCerror)B) or error rate RCOV \@ref(fig:logFCerror)C). 
An additional mixed-effects model was used to determine feature characteristics that are correlated with logFC error rate. 
Increased estimated logFC and logCPM were significantly related to lower error rates. 

Overall poor agreement between expected and estimated log fold-change estimates. 
Which is inconsistent with the relative abundance error assessment (Fig. \@ref(fig:relAbuErrorPre))

__TODO__ Need to figure out how to present the results for this statement 

While some the poor agreement can be attributed to low abundance (noisy data), or smaller differences in the log fold-change between pre- and post-exposure samples.


Analysis of the log fold-change error results indicated a feature specific performance effect (Fig. \@ref(fig:logFCfeat)). 



```{r preCountTbl, echo = FALSE}
logFC_pre %>% filter(T1 == 0, T2 == 20) %>%
      mutate(Type = if_else(T00 == 0, "specific", "dominant")) %>% 
      group_by(pipe, biosample_id, Type) %>% 
      summarise(count = n()) %>% 
      spread(pipe, count,fill = 0) %>% 
      dplyr::rename(Individual = biosample_id) %>% 
      knitr::kable(caption = "Number of pre-specific and pre-dominant features by individual and pipeline", booktabs = TRUE)
```

```{r logFCerror, fig.cap = "Relationship between the observed and expected logFC for pre-specific and pre-domiant features by pipeline and individual for all titration pair comparisons. Orange line indicates expected 1-to-1 relationship between the estimated and expected logFC. Blue line is a linear model was fit to the data and grey area is the models uncertainty estimate. Distribution of feature-level log-fold change error by individual and pipeline as the (B) slope and (C) R2 for a linear model fit to the estimated and expected log fold-change values ", echo = FALSE, fig.height = 8}
ggarrange(logFCestVexp, 
          slope_logFC + rremove("x.text"), 
          r2_logFC, 
          labels = c("A", "B", "C"),
          # align = "v", 
          ncol = 1, nrow = 3, 
          heights = c(0.5,0.2,0.3))
```