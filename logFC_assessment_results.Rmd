---
title: "logFC Assessment"
author: "Nate Olson"
date: '`r Sys.Date()`'
output:
  bookdown::pdf_document2: 
    toc: FALSE
---



```{r logFCsetup, include=FALSE}
library(nlme)
library(ape)
library(multcomp)
library(tidyverse)
library(stringr)
library(ggpubr)
```

```{r logFCmunge, include = FALSE}
### Loading Data ---------------------------------------------------------------
### RDS file generated in 2017-10-19_logFC-error-metrics.RDS 
logFC_pre <- readRDS("~/Desktop/logFC_pre.RDS")

logFC_feature_summary <- readRDS("~/Desktop/logFC_feature_summary.RDS") %>% 
      mutate(slope_error = 1 - slope)


### logFC Error Rate Plot Code ------------------------------------------------
### Estimated v. Expected 
logFCestVexp <- logFC_pre %>% 
      filter(T1 != 0, T2 != 20) %>% 
      ggplot() + 
      geom_point(aes(x = exp_logFC, y = logFC)) +
      geom_smooth(aes(x = exp_logFC, y = logFC), method = "lm") +
      geom_abline(aes(intercept = 0, slope = 1), color = "darkorange") + 
      facet_grid(pipe~biosample_id, scales = "free_y") + theme_bw()  +
      labs(x = "Expected", y = "Estimate") 

### Median logFC Error Rate  
# Note filtering slope < 4 is a bit arbitrary
slope_logFC <- filter(logFC_feature_summary, slope < 4) %>% ggplot() + 
      geom_boxplot(aes(x = pipe, y = slope_error)) + 
      facet_wrap(~biosample_id) +
      theme_bw() +
      labs(x = "Individual", y = "1 - Slope") 

### RCOV logFC Error Rate  
r2_logFC <- filter(logFC_feature_summary, slope < 4) %>% ggplot() + 
      geom_boxplot(aes(x = pipe, y = adj.r.squared)) + 
      facet_wrap(~biosample_id) +
      theme_bw() +
      labs(x = "Individual", y = "Adjusted R2")
```


```{r logFCstats, echo = FALSE, message = FALSE, warning = FALSE}
fit_dat <- logFC_feature_summary %>% 
      filter(slope < 4) %>%
      filter(pipe != "unclustered") %>% 
      mutate(pipe = factor(pipe))

## Bias - Error rate -----------------------------------------------------------
# Fitting mixed effects model with individual as the fixed effect
slope_fit <- nlme::lme(slope_error ~ pipe, random =  ~ 1 | biosample_id, 
                 data = fit_dat)  
## Residual check
# qqnorm(slope_fit$residuals) + abline(a = 0, b =  1, col = 'red')

# Pipe 1-slope estimates
dada_slope <- slope_fit$coefficients$fixed['(Intercept)']
mothur_slope <- dada_slope + slope_fit$coefficients$fixed['pipemothur']
qiime_slope <- dada_slope + slope_fit$coefficients$fixed['pipeqiime']

slope_anova <- anova(slope_fit)
slope_f <- slope_anova$`F-value`
slope_p <- slope_anova$`p-value`

# Checking whether indiviudal or pipeline contributes more to the overal vaiance
slope_var <- ape::varcomp(slope_fit)

## Variance - RCOV -------------------------------------------------------------
# Fitting mixed effects model with individual as the fixed effect
r2_fit <- nlme::lme(adj.r.squared ~ pipe, random =  ~ 1 | biosample_id, 
                 data = fit_dat)

# qqnorm(r2_fit$residuals) + abline(a = 0, b =  1, col = 'red')

# Pipe R2 estimates
dada_r2 <- r2_fit$coefficients$fixed['(Intercept)']
mothur_r2 <- dada_r2 + r2_fit$coefficients$fixed['pipemothur']
qiime_r2 <- dada_r2 + r2_fit$coefficients$fixed['pipeqiime']

r2_anova <- anova(r2_fit)
r2_f <- r2_anova$`F-value`
r2_p <- r2_anova$`p-value`

# Checking whether indiviudal or pipeline contributes more to the overal vaiance
r2_var <- ape::varcomp(r2_fit)
```

```{r preCountTbl, echo = FALSE}
logFC_pre %>% filter(T1 == 0, T2 == 20) %>%
      mutate(Type = if_else(T00 == 0, "specific", "dominant")) %>% 
      group_by(pipe, biosample_id, Type) %>% 
      summarise(count = n()) %>% 
      spread(pipe, count,fill = 0) %>% 
      dplyr::rename(Individual = biosample_id) %>% 
      knitr::kable(caption = "Number of pre-specific and pre-dominant features by individual and pipeline", booktabs = TRUE)
```

```{r logFCerror, fig.cap = "Relationship between the observed and expected logFC for pre-specific and pre-domiant features by pipeline and individual for all titration pair comparisons. Orange line indicates expected 1-to-1 relationship between the estimated and expected logFC. Blue line is a linear model was fit to the data and grey area is the models uncertainty estimate. Distribution of feature-level log-fold change error by individual and pipeline as the (B) slope and (C) R2 for a linear model fit to the estimated and expected log fold-change values ", echo = FALSE, fig.height = 8}
ggarrange(logFCestVexp, 
          slope_logFC + rremove("x.text"), 
          r2_logFC, 
          labels = c("A", "B", "C"),
          # align = "v", 
          ncol = 1, nrow = 3, 
          heights = c(0.5,0.2,0.3))
```

__NOTE__ Need reasoning for excluding slope > 4

__Summary statement about the overall agreement between log fold-change estimates and expected values.__

The slope and $R^2$ values for linear models of the estimated and expected log fold-change for individual features, all titration comparison, were used to characterize the log fold-change bias and variance across pipelines. 
Features with with slope > 4 were excluded from the log fold-change bias and variance analysis. 
A error metric of $1 - slope$ was used, where 0 is the desired value (i.e. log fold-change estimate = log fold-change expected), negative and positive values indicate the log-fold change was consistently under and over estimated. 
The linear model $R^2$ value was used to characterize the feature-level log fold-change variance as it indicates how consistent the relationship between the log fold-change estimates and expected values are across titration comparisons. 
Similar to the relative abundance assessment we used a mixed-effects models to take into account differences in individuals when comparing the log fold-change error rates between pipeline. 
The log fold-change bias metric was not significantly different between pipelines (F = `r round(slope_f,2)`, p = `r round(slope_p,2)`, DADA2 `r round(dada_slope,2)`, Mothur `r round(mothur_slope,2)`, QIIME `r round(qiime_slope,2)`, \@ref(fig:logFCerror)B). 
The log fold-change variance metric was not significantly different between pipelines (F = `r round(r2_f,2)`, p = `r round(r2_p,2)`, DADA2 `r round(dada_r2,2)`, Mothur `r round(mothur_r2,2)`, QIIME `r round(qiime_r2,2)` \@ref(fig:logFCerror)C).

__TODO__ Incorporate analysis into text   

While some of the poor agreement can be attributed to low abundance (noisy data), or smaller differences in the log fold-change between pre- and post-exposure samples.
An additional mixed-effects model was used to determine feature characteristics that are correlated with logFC error rate. 
Increased estimated logFC and logCPM were significantly related to lower error rates. 
Analysis of the log fold-change error results indicated a feature specific performance effect. 



