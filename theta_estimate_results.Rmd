---
title: "Microbiome Scale Theta Estimate Results"
author: "Nate Olson"
date: '`r Sys.Date()`'
output:
  bookdown::pdf_document2: 
    toc: FALSE
---

```{r theta_setup, warning=FALSE, message=FALSE, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
library(tidyverse)
library(stringr)
library(modelr)
```

```{r loadData, warning=FALSE, message=FALSE, echo = FALSE}
## Raw count data with pre and post negative binomial count proportions
count_nb <- readRDS("data/nb_expected_eo_metric_feature_update_df.rds") %>% 
      mutate(count_post = post * total_abu, count_pre = pre * total_abu)


## Excluding features with median EO metric of 1 or -1 and logFC between pre and post < 1
## %%TODO%% replace with heuristic filter > 14 of the PCR replicates have observed counts, and only features with observed counts for unmixed samples.  
good_eo <- count_nb %>% group_by(pipe, biosample_id, feature_id) %>% 
      summarise(med_eo = median(eo_metric)) %>% 
      filter(abs(med_eo) != 1)

prepost_logFC <- readRDS("data/pre_post_deseq_logFC.RDS")

good_logfc <- prepost_logFC %>% 
    filter(abs(log2FoldChange) > 1, pvalue < 0.05) 


good_features <- good_eo %>% inner_join(good_logfc)

count_nb_good <- count_nb %>% right_join(good_features)
```

```{r thetaFeaturesMA, echo = FALSE, fig.cap = "MA plot (x-axis mean abundance, y-axis log2 fold change between unmixed pre- and post-exposure samples. Orange points indicate features used to estimate theta. Dashed lines indicate the +/- 1 log2 fold change filter used when to pick features."}
prepost_logFC %>% ggplot() + 
      geom_point(aes(x = baseMean, y = log2FoldChange), color = "grey60", alpha = 0.25) +
      geom_hline(aes(yintercept = -1), linetype = 2) + 
      geom_hline(aes(yintercept = 1), linetype = 2) +
      geom_point(data = good_features, aes(x = baseMean, y = log2FoldChange), 
                 color = "darkorange",alpha = 0.5) + 
      facet_grid(pipe~biosample_id) + 
      scale_x_log10() + theme_bw() +
      labs(y = "log2 Fold-Change", x = "Mean Abundance")
```


```{r thetaFeatures, warning=FALSE, message=FALSE, echo = FALSE}
count_nb_good %>% ungroup() %>% 
      select(pipe, biosample_id, feature_id) %>% unique() %>% 
      group_by(pipe, biosample_id) %>% summarise(count = n()) %>% 
      spread(biosample_id, count) %>% 
      knitr::kable(booktab = TRUE, caption = "Number of features used to estimate theta by biological replicate and pipeline.")
```


```{r fitModel, warning=FALSE, message=FALSE, echo = FALSE}
#### For a weighted regression ----------------------------
## VOOM version - fit model error versus mean 
## use residuals vs. mean and estimate smooth function 
## use function as weight sigma vs. mean plot 

munge_strap <- function(data){
      data %>% as.data.frame() %>% 
            add_column(boot_id = 1:nrow(.)) %>% 
            gather("pcr_count","count_val", -boot_id, -feature_id) %>% 
            separate(pcr_count, c("pcr_rep","count_type"), sep = "::") %>% 
            spread(count_type, count_val)
}

calc_boot_theta <- function(boot_theta_file, count_nb_good){
      if(file.exists(boot_theta_file)){
            boot_theta_hat <- readRDS(boot_theta_file)
            return(boot_theta_hat)
      }
      count_boot <- count_nb_good %>% 
            mutate(t_fctr = factor(t_fctr, levels = c(1:5,10,15)),
                   theta = 2^-as.numeric(t_fctr),
                   pcr_rep = paste0("pcr_",str_replace(pcr_rep, ":", "_"))) %>% 
            ungroup() %>% 
            select(pipe, biosample_id, theta, t_fctr, feature_id, 
                   pcr_rep, count, count_post, count_pre, total_abu) %>% 
            gather("count_type","count_val", -pipe, -biosample_id, 
                   -theta, -t_fctr, -feature_id, -pcr_rep) %>% 
            mutate(pcr_count = paste(pcr_rep, count_type, sep = "::")) %>%
            select(-pcr_rep, -count_type) %>% 
            spread(pcr_count, count_val) %>%
            group_by(pipe, biosample_id, theta, t_fctr) %>%
            nest() %>%
            mutate(boot_dat = map(data, modelr::bootstrap, 1000))
      
      boot_fit <- count_boot %>% select(-data) %>% unnest() %>% 
            mutate(strap_pcr = map(strap, munge_strap)) %>% 
            mutate(fit = map(strap_pcr, ~lm(count ~ -1 + I(count_post - count_pre),
                                            offset = count_pre, data = .)))
      
      boot_theta_hat <- boot_fit %>% 
            mutate(theta_hat = map_dbl(fit, coef)) %>% 
            select(-fit,-strap) %>% 
            group_by(pipe, biosample_id, theta, t_fctr) %>% 
            summarise(theta_hat_mean = mean(theta_hat),
                      theta_hat_lci = quantile(theta_hat, probs = 0.025),
                      theta_hat_uci = quantile(theta_hat, probs = 0.975),
                      theta_var = var(theta_hat)) %>% 
            mutate(theta_bias = theta_hat_mean - theta)
      
      saveRDS(boot_theta_hat, boot_theta_file)
      
      boot_theta_hat
}

boot_theta_file <- "data/bootstrap_theta_estimates.rds"
boot_theta_hat <- calc_boot_theta(boot_theta_file, count_nb_good)
```



Statement regarding the number of features per biological replicate/ pipeline
Statement about MA plot

Consistent deviation across pipeline and titration from the expected $\theta$ values indicates our assumptions regarding the composition of the mixtures are not valid (Fig. \@ref(fig:thetaHat)). 
Our assumptions are that the DNA from the pre- and post-treatment samples were titrated following a log2 dilution series and that the pre- and post-treatment samples contained similar proportions of bacterial DNA. 
The qPCR spike-in results indicate that the unmixed pre- and post-treatment samples were mixed volumetrically according to our expectations. 
Based on the qPCR bacterial DNA concentration assays, the pre-treatment E01JH0038 sample had the lowest concentration of bacterial DNA between the five biological replicates and the bacterial DNA concentration was higher in the pre-treatment sample compared to the post-treatment sample for only E01JH0017 (Fig __qPCR Bacterial Concentration__).

```{r thetaHat, echo = FALSE, fig.cap = "Theta estimates by titration, biological replicate, and bioinformatic pipeline. The points indicate mean estimate of 1000 bootstrap theta estimates and errorbars 95\\% confidence interval. The black line indicates the expected theta values. Theta estimates below the expected theta indicate that the titrations contains less than expected bacterial DNA from the post-treatment sample. Theta estimates greater than the expected theta indicate the titration contains more bacterial DNA from the pre-treatment sample than expected."}
ggplot(boot_theta_hat) + 
      geom_point(aes(x = t_fctr, y = theta_hat_mean, color = pipe, shape = pipe)) + 
      geom_errorbar(aes(x = t_fctr, ymin = theta_hat_lci, 
                        ymax = theta_hat_uci, color = pipe),width = 0.2) + 
      geom_line(aes(x = as.numeric(t_fctr), y =  theta)) + 
      facet_grid(biosample_id~pipe, scale = "free_y") + theme_bw() +
    labs(x = "Titration Factor", y = expression(theta), color = "Pipeline", shape = "Pipeline") + 
    theme(legend.position = "bottom")
```





