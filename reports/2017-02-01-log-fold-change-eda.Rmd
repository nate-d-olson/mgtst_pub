---
title: "logFC Initial Exploratory Analysis"
author: "Nate Olson"
date: '`r Sys.Date()`'
output: html_document
---

```{r message = FALSE}
library(ProjectTemplate)
cwd <- getwd()
setwd("../")
load.project()
setwd(cwd)
```

## Objective
Initial analysis of the logFC calculation results.  

* Looking at agreement between logFC estimates 
* Comparing estimated logFC to expected value for pre and post specific OTUs  
* Looking at feature level logFC variance estimates  

## Loading Data 
Input data is the tidy data frames generated by `2017-02-01-log-fold-change-df_dev.Rmd`.  

```{r}
logFC_MgSeq <- readRDS("../data/logFC_MgSeq_df.rds")
logFC_DESeq2 <- readRDS("../data/logFC_DESeq2_df.rds")
logFC_edgeR <- readRDS("../data/logFC_edgeR_df.rds")
```


### MgSeq logFC and SE Estimates
```{r}
glimpse(logFC_MgSeq)
```

Subset of data to make it easier to work with
```{r}
logFC_MgSeq_sub <- logFC_MgSeq %>% filter(!is.na(logFC), !is.na(se)) %>% sample_frac(size = 0.25)
```

logFC estimate distributions:  

For all five of the biological replicates most of the logFC estimates were between -2 and 2 log2. 
```{r}
logFC_DESeq2_sub %>% ggplot() + geom_boxplot(aes(x = pipe, y = logFC, color = sampleID)) +
      theme_bw()
```

logFC estimate distributions:  

For all five of the biological replicates the standard error for most log fold-change estimates was less than 1. 
However, there were some log fold-change estimates with large standard error estimates for all biological replicates.  
```{r}
logFC_MgSeq_sub %>% ggplot() + 
      geom_boxplot(aes(x = pipe, y = se, color = sampleID)) + theme_bw() + scale_y_log10()
```

Log fold-change estimates with large standard errors are between -3 and and 2. 
Most of the features with outlier standard errors are from the QIIME pipeline. 
However, this is potentially biased as QIIME pipeline had the most features to begin with.  

```{r}
outlier_se <- logFC_MgSeq_sub %>% group_by(sampleID) %>% 
      mutate(u99 = quantile(se, 0.995)) %>% filter(se > u99) 
```

```{r}
outlier_se %>% {summary(.$logFC)}
```

```{r}
outlier_se %>% ggplot() + geom_bar(aes(x=pipe)) + theme_bw()
```

Features with log fold-change estimates with outlier standard error estimates. 

```{r}
outlier_se %>% group_by(pipe) %>% summarise(n_features = n_distinct(featureNames))
```

A number of the features with log fold change standard error estimates that are outliers, were outliers for multiple titration comparisons.  

```{r}
outlier_se %>% group_by(pipe, featureNames) %>% summarise(count = n()) %>% filter(count > 2)
```

## Relationship between logFC estimates and Standard Errors 

```{r}
logFC_MgSeq_sub %>% 
      ggplot() + geom_point(aes(x = logFC, y = se, color = factor(T1)), alpha = 0.25) + 
      scale_y_log10() + facet_wrap(pipe~sampleID, scale = "free_y") + theme_bw()
```

The log fold change between adjacent titrations will be smaller as the samples are more similar, 
this effect increases with titration level. 
This is evident with narrowing of the point distributions. 
A naive expectation is that the log fold-change should not be greater than the difference in the sample titation values.  

Excluding featues with outlier standard error estimates 
```{r}
logFC_MgSeq_sub %>% group_by(sampleID) %>% 
      mutate(u99 = quantile(se, 0.995)) %>% filter(se < u99)  %>%
      ggplot() + geom_point(aes(x = logFC, y = se, color = sampleID, shape = pipe), alpha = 0.25) + 
      geom_vline(aes(xintercept = 1), color = "grey") + 
      geom_vline(aes(xintercept = -1), color = "grey") + 
      facet_grid(T1~T2) + theme_bw()
```

Separate plots for the different pipelines
```{r}
logFC_MgSeq_sub %>% group_by(sampleID) %>% 
      mutate(u99 = quantile(se, 0.995)) %>% filter(se < u99, pipe == "dada2")  %>%
      ggplot() + geom_point(aes(x = logFC, y = se, color = sampleID, shape = pipe), alpha = 0.25) + 
      geom_vline(aes(xintercept = 1), color = "grey") + 
      geom_vline(aes(xintercept = -1), color = "grey") + 
      facet_grid(T1~T2) + theme_bw()
```

```{r}
logFC_MgSeq_sub %>% group_by(sampleID) %>% 
      mutate(u99 = quantile(se, 0.995)) %>% filter(se < u99, pipe == "mothur")  %>%
      ggplot() + geom_point(aes(x = logFC, y = se, color = sampleID, shape = pipe), alpha = 0.25) + 
      geom_vline(aes(xintercept = 1), color = "grey") + 
      geom_vline(aes(xintercept = -1), color = "grey") + 
      facet_grid(T1~T2) + theme_bw()
```


```{r}
logFC_MgSeq_sub %>% group_by(sampleID) %>% 
      mutate(u99 = quantile(se, 0.995)) %>% filter(se < u99, pipe == "qiime")  %>%
      ggplot() + geom_point(aes(x = logFC, y = se, color = sampleID, shape = pipe), alpha = 0.25) + 
      geom_vline(aes(xintercept = 1), color = "grey") + 
      geom_vline(aes(xintercept = -1), color = "grey") + 
      facet_grid(T1~T2) + theme_bw()
```
### DESeq2 logFC and SE Estimates
```{r}
glimpse(logFC_DESeq2)
```

Subset of data to make it easier to work with
```{r}
## renaming variables for consistency between differential abundance methods
logFC_DESeq2_sub <- logFC_DESeq2 %>% dplyr::rename(logFC = log2FoldChange, se = lfcSE) %>% 
      filter(!is.na(logFC), !is.na(se)) %>% sample_frac(size = 0.25)
```

For all five of the biological replicates most of the logFC estimates were between -4 and 4 log2. 
The DADA2 logFC estimates tend to be larger compare to the pipelines. 
This could be due to improper clustering of sequences. 
Where a sequence is incorretly clustered with another sequence that is highly abundant in one sample but only improperly sequences are cluster leading to inflated log fold-change estimates.  

```{r}
logFC_DESeq2_sub %>% ggplot() + geom_boxplot(aes(x = pipe, y = logFC, color = sampleID)) +
      theme_bw()
```

### Distribution of standard error estimates
No extremely large standard error estimates like thoes observed for fitFeatureModel. 
Not sure what to make of the standard error estimates for mothur concentrated around 3.4. 

```{r}
logFC_DESeq2_sub %>% ggplot() + 
      geom_boxplot(aes(x = pipe, y = se, color = sampleID)) + theme_bw()
```

### Relationship Between logFC and Standard Errror 

#### DADA2
```{r}
logFC_DESeq2_sub %>% group_by(sampleID) %>% filter(pipe == "dada2") %>% 
      # mutate(u99 = quantile(se, 0.995)) %>% filter(se < u99)  %>%
      ggplot() + geom_point(aes(x = logFC, y = se, color = sampleID, shape = pipe), alpha = 0.25) + 
      geom_vline(aes(xintercept = 1), color = "grey") + 
      geom_vline(aes(xintercept = -1), color = "grey") +
      facet_grid(T1~T2) + theme_bw()
```

#### Mothur
```{r}
logFC_DESeq2_sub %>% group_by(sampleID) %>% filter(pipe == "mothur") %>% 
      # mutate(u99 = quantile(se, 0.995)) %>% filter(se < u99)  %>%
      ggplot() + geom_point(aes(x = logFC, y = se, color = sampleID, shape = pipe), alpha = 0.25) + 
      geom_vline(aes(xintercept = 1), color = "grey") + 
      geom_vline(aes(xintercept = -1), color = "grey") +
      facet_grid(T1~T2) + theme_bw()
```


#### QIIME 
```{r}
logFC_DESeq2_sub %>% group_by(sampleID) %>% filter(pipe == "qiime") %>% 
      # mutate(u99 = quantile(se, 0.995)) %>% filter(se < u99)  %>%
      ggplot() + geom_point(aes(x = logFC, y = se, color = sampleID, shape = pipe), alpha = 0.25) + 
      geom_vline(aes(xintercept = 1), color = "grey") + 
      geom_vline(aes(xintercept = -1), color = "grey") +
      facet_grid(T1~T2) + theme_bw()
```

### edgeR logFC Estimates  
edgeR did not calculate the standard error for the log fold-change

```{r}
glimpse(logFC_edgeR)
```

Subset of data to make it easier to work with
```{r}
## renaming variables for consistency between differential abundance methods 
## Subsetting for features of interest
logFC_edgeR_sub <- logFC_edgeR %>% 
      select(pipe, sampleID, T1, T2, OTUname, logFC) %>% dplyr::rename(featureName = OTUname) %>%  
      filter(!is.na(logFC)) %>% sample_frac(size = 0.25)
```

For all five of the biological replicates most of the logFC estimates were between -2 and 2 log2. 
The DADA2 logFC estimates tend to be larger compare to the pipelines. 
This could be due to improper clustering of sequences. 
Where a sequence is incorretly clustered with another sequence that is highly abundant in one sample but only improperly sequences are cluster leading to inflated log fold-change estimates.  

```{r}
logFC_edgeR_sub %>% ggplot() + 
      geom_hline(aes(yintercept = -2)) + geom_hline(aes(yintercept = 2)) + 
      geom_boxplot(aes(x = pipe, y = logFC, color = sampleID)) +
      theme_bw()
```



### logFC by titration comparisons 
```{r}
logFC_edgeR_sub %>% ggplot() + 
      geom_hline(aes(yintercept = -2)) + geom_hline(aes(yintercept = 2)) + 
      geom_boxplot(aes(x = pipe, y = logFC)) +
      theme_bw() + facet_grid(T1~T2)
```



## Method Agreement
Can only compare differential abundance methods by pipeline as the features are not directly comparable, can look into comparing by taxonomic classification later.  

```{r}
MgSeq <- logFC_MgSeq %>% filter(!is.na(logFC), !is.na(logFC)) %>% 
      select(pipe, sampleID, T1, T2, featureNames, logFC) %>% 
      dplyr::rename(logFC_MgSeq = logFC)
DSeq <- logFC_DESeq2 %>% dplyr::rename(logFC = log2FoldChange) %>%
      select(pipe, sampleID, T1, T2, featureNames, logFC) %>% 
      dplyr::rename(logFC_DESeq2 = logFC)
edge <- logFC_edgeR %>% dplyr::rename(featureNames = OTUname) %>% 
      select(pipe, sampleID, T1, T2, featureNames, logFC) %>% 
      dplyr::rename(logFC_edgeR = logFC)
```

```{r}
diff_abu_comp <- MgSeq %>% inner_join(DSeq) %>% inner_join(edge)
```

Only 66K features had log fold change estimates for all three differential abundance methods. 
No features were called for all 

```{r}
diff_abu_comp %>% ggplot() + 
      geom_abline(aes(intercept = 0, slope = 1), linetype = 2) + 
      geom_point(aes(x = logFC_MgSeq, y = logFC_DESeq2, fill = sampleID),
                 shape = 21, color = "white",  alpha = 0.25) +
      facet_grid(.~pipe)
```

```{r}
diff_abu_comp %>% ggplot() + 
      geom_abline(aes(intercept = 0, slope = 1), linetype = 2) + 
      geom_point(aes(x = logFC_MgSeq, y = logFC_edgeR, fill = sampleID),
                 shape = 21, color = "white",  alpha = 0.25) +
      facet_grid(.~pipe)
```

```{r}
diff_abu_comp %>% ggplot() + 
      geom_abline(aes(intercept = 0, slope = 1), linetype = 2) + 
      geom_point(aes(x = logFC_DESeq2, y = logFC_edgeR, fill = sampleID),
                 shape = 21, color = "white",  alpha = 0.25) +
      facet_grid(.~pipe)
```

```{r}
## Downsample for more manageable dataset
diff_abu_comp %>% sample_frac(0.25) %>% 
      gather("diff_abu", "logFC", -pipe, -sampleID, -T1, -T2,
             -featureNames,factor_key = TRUE) %>% 
      mutate(group_set = paste(pipe, sampleID, T1, T2, featureNames)) %>% 
      ggplot() + 
      geom_point(aes(x = diff_abu, y = logFC)) + 
      geom_line(aes(x = as.numeric(diff_abu), y = logFC, group = group_set), alpha = 0.05) +
      facet_wrap(~pipe)
```

```{r}
## only features with logFC > +/- 1
diff_abu_comp %>% filter(logFC_MgSeq < -1 | logFC_MgSeq > 1 | 
                         logFC_DESeq2 < -1 | logFC_DESeq2 > 1 |
                         logFC_edgeR < -1 | logFC_edgeR > 1) %>%  #sample_frac(0.25) %>% 
      gather("diff_abu", "logFC", -pipe, -sampleID, -T1, -T2,
             -featureNames,factor_key = TRUE) %>% 
      mutate(group_set = paste(pipe, sampleID, T1, T2, featureNames)) %>% 
      ggplot() + 
      geom_point(aes(x = diff_abu, y = logFC)) + 
      geom_line(aes(x = as.numeric(diff_abu), y = logFC, group = group_set), alpha = 0.05) +
      facet_wrap(~pipe)
```

