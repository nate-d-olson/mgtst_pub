---
title: "Titration Abundance Expectation Calculation"
author: "Nate Olson"
date: '`r Sys.Date()`'
always_allow_html: yes
output:
  pdf_document: default
  html_document: default
---

```{r setup, warning=FALSE, message=FALSE, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(ProjectTemplate)
cwd <- getwd()
setwd("../")
load.project()
setwd(cwd)
```

```{r echo = FALSE}
pipeline_dir <- "../../mgtst_pipelines"
mrexp <- get_mrexp(pipeline_dir)
```

## Objective
Generate a data_frame with observed and predicted count values for individual PCR replicates. 
Expected values are calculated using unmixed PCR count table values from the same set of PCR replicates, same half of one of the replicate 96 well plates. 



```{r}
## Extracting a tidy dataframe with count values from MRexpiment objects
get_count_df <- function(mrobj){
      mrobj <- cumNorm(mrobj, p = 0.75)
      mrobj %>%
            # not sure whether or not to normalize counts prior to analysis
            MRcounts(norm = TRUE, log = FALSE, sl = 1000) %>%  
            #MRcounts(sl = 1) %>% 
            as.data.frame() %>% 
            rownames_to_column(var = "feature_id") %>% 
            gather("id","count", -feature_id)
}

count_df <- mrexp %>% map_df(get_count_df, .id = "pipe")

## Annotate with meta data and exclude NTCs
count_df <- pData(mrexp$dada2) %>% right_join(count_df) %>%
      filter(biosample_id != "NTC")
```  

```{r}
count_df %>% glimpse()
```


Extracting observed count values for unmixed pre and post samples

```{r}
## Pre and post full features are not necessarily pre or post specific
post_count <- count_df %>%
      filter(t_fctr == 0) %>%
      select(pipe, biosample_id, feature_id, pcr_rep, count) %>%
      dplyr::rename(post_count = count) 

pre_count <- count_df %>%
      filter(t_fctr == 20) %>%
      select(pipe, biosample_id, feature_id, pcr_rep, count) %>%
      dplyr::rename(pre_count = count) 

pre_post_count <-  full_join(pre_count, post_count) %>% 
      mutate(pre_count = if_else(is.na(pre_count), 0, pre_count),
             post_count = if_else(is.na(post_count), 0, post_count))
``` 

Use observed count values and titration factor to calculate expected values for titrations. 

```{r}
titration_list <- data_frame(titration = c(1:5,10,15)) %>% 
      mutate(post_prop = 2^-titration) %>% list() %>% rep(nrow(pre_post_count))

titration_pred <- pre_post_count %>% ungroup() %>% 
      add_column(titration = titration_list) %>% unnest() %>% 
      mutate(exp_count = post_count * post_prop + pre_count * (1-post_prop))
```

```{r}
count_exp_df <- count_df %>% 
      ungroup() %>% 
      filter(titration %in% c(1:5,10,15)) %>%  
      dplyr::rename(obs_count = count) %>% 
      right_join(titration_pred) %>% 
      mutate(residual = exp_count - obs_count)
```

```{r}
count_exp_df %>% glimpse()
```

```{r}
count_exp_df %>% saveRDS("../data/expected_count_values_df.rds") 
```

## Session information
```{r}
s_info <- devtools::session_info()
print(s_info$platform)
s_info$packages %>% filter(`*` == "*") %>% select(-`*`) %>% 
      knitr::kable()
``` 