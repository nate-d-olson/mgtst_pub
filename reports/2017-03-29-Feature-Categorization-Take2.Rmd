---
title: "Feature Classification Take 2"
author: "Nate Olson"
date: '`r Sys.Date()`'
always_allow_html: yes
output:
  pdf_document: default
  html_document: default
---

## Objective 
Revise feature classifications to define situations that result in different performance expectation. 


Inorder to fit a regression model, need features with observed counts in at least 3 titrations and pre or post unmixed samples 

```{r setup, warning=FALSE, message=FALSE, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(ProjectTemplate)
cwd <- getwd()
setwd("../")
load.project()
setwd(cwd)
```

```{r echo = FALSE}
pipeline_dir <- "../../mgtst_pipelines"
mrexp <- get_mrexp(pipeline_dir)
```

```{r}
## Extracting a tidy dataframe with count values from MRexpiment objects
get_count_df <- function(mrobj){
      mrobj <- cumNorm(mrobj, p = 0.75)
      mrobj %>%
            # not sure whether or not to normalize counts prior to analysis
            MRcounts(norm = TRUE, log = FALSE, sl = 1000) %>%  
            as.data.frame() %>% 
            rownames_to_column(var = "feature_id") %>% 
            gather("id","count", -feature_id)
}

count_df <- mrexp %>% map_df(get_count_df, .id = "pipe")

count_replicate_df <- pData(mrexp$dada2) %>% right_join(count_df) %>% 
      filter(biosample_id != "NTC") %>%
      mutate(detect = if_else(count > 0, 1, 0)) %>%
      group_by(pipe, biosample_id, titration, t_fctr, feature_id) %>% 
      summarise(total_detect = sum(detect),
                n_replicates = n(),
                avg_non0_count = sum(count)/total_detect) %>%
      mutate(detect_prop = total_detect/n_replicates) %>% 
      select(-total_detect) 

rep_info <- count_replicate_df %>% ungroup() %>% 
      mutate(t_fctr = paste0("T",t_fctr)) %>% 
      select(pipe, biosample_id, feature_id, t_fctr, detect_prop) 
```

```{r}
prop_summary <- rep_info %>% 
      group_by(pipe, biosample_id, feature_id) %>% 
      summarise(prop_max = max(detect_prop), 
                prop_min = min(detect_prop), 
                prop_sum = sum(detect_prop)) 

unmix_prop <- rep_info %>% 
      filter(t_fctr %in% c("T0","T20")) %>% 
      spread(t_fctr, detect_prop)

feature_cat <- left_join(prop_summary, unmix_prop) %>% 
      mutate(cat_null = if_else(prop_max < 0.5, 1, 0),
             cat_full = if_else(prop_min > 0, 1, 0),
             cat_mix  = if_else(prop_max >= 0.5 & T0 == 0 & T20 == 0, 1, 0),
             cat_pre  = if_else(T20 >= 0.75 & T0 == 0 & prop_sum > 2, 1, 0),
             cat_post = if_else(T0 >= 0.75 & T20 == 0 & prop_sum > 5, 1, 0),
             cat_none = if_else(cat_null + cat_full + cat_mix + cat_pre + cat_post == 0, 1, 0))


```

Category Sanity Check
```{r}
cat_check <- feature_cat %>% 
      select(pipe, biosample_id, feature_id, 
             cat_null, cat_full, cat_mix, cat_pre, cat_post, cat_none) %>% 
      gather(cat, value, -pipe, -biosample_id, -feature_id) %>% 
      group_by(pipe, biosample_id, feature_id) %>% 
      summarise(n_cat = sum(value))
cat_check %>% filter(n_cat != 1)
```


```{r}
# cat_check <- feature_categories %>% 
#       select(pipe, biosample_id, feature_id, 
#              cat_null, cat_full, cat_mix, cat_pre, cat_post, cat_none) %>% 
#       gather(cat, value, -pipe, -biosample_id, -feature_id) %>% 
#       group_by(pipe, biosample_id, feature_id) %>% 
#       mutate(n_cat = sum(value)) %>% 
#       filter(n_cat != 1, value != 0)
# cat_check %>% arrange(feature_id)
```




```{r}
feature_categories <- feature_cat %>% select(pipe, biosample_id, feature_id, 
             cat_null, cat_full, cat_mix, cat_pre, cat_post, cat_none) %>% 
      gather(cat, value, -pipe, -biosample_id, -feature_id) %>% 
      filter(value == 1) %>% select(-value)
```

### Save Data Frame as RDS
```{r}
feature_categories %>% saveRDS("../data/feature_categories_df.rds") 
```


## Summary Figures
```{r}
feature_categories %>% filter(cat != "cat_null") %>% 
      ggplot() + geom_bar(aes(x = cat)) + 
      facet_grid(pipe ~ biosample_id, scales = "free_y") + 
      theme_bw() + theme(axis.text.x = element_text(angle = 90))
```

While there are a large number of unclassified features, few are potentially informative. 

```{r}
feature_cat %>% filter(cat_none == 1, prop_sum > 2, T0 > 0.5, T20 > 0.5) %>%
      ggplot() + geom_histogram(aes( x= prop_sum)) + facet_grid(T0 ~ T20) + theme_bw()
```

# Session information
```{r}
s_info <- devtools::session_info()
print(s_info$platform)
s_info$packages %>% filter(`*` == "*") %>% select(-`*`) %>% 
      knitr::kable()
```